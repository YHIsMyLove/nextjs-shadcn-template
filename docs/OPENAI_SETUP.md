# OpenAI API 安全配置指南

## 问题说明

原项目存在在浏览器端直接调用 OpenAI API 的安全隐患，这会导致：
- API 密钥暴露在浏览器中
- 触发 OpenAI 的安全警告
- 违反最佳安全实践

## 解决方案

我们采用了 Next.js API Routes 的方式来安全地调用 OpenAI API：

### 架构变更

**之前的架构（不安全）：**
```
浏览器 → 直接调用 OpenAI API
```

**现在的架构（安全）：**
```
浏览器 → Next.js API Route → OpenAI API
```

### 文件变更说明

1. **新增文件：**
   - `src/app/api/generate/route.ts` - 服务端 API 路由
   - `.env.local` - 环境变量配置文件

2. **修改文件：**
   - `src/app/page.tsx` - 移除直接 OpenAI 调用，改为调用本地 API
   - `src/lib/openai.ts` - 更新为 API 调用辅助函数

## 使用步骤

### 1. 配置 API 密钥

在项目根目录的 `.env.local` 文件中设置您的 OpenAI API 密钥：

```env
OPENAI_API_KEY=your_actual_openai_api_key_here
```

**重要：**
- 不要将 `.env.local` 文件提交到版本控制系统
- 如果没有 `.env.local` 文件，请复制 `.env.example` 并重命名

### 2. 安装依赖

```bash
pnpm install
```

### 3. 启动开发服务器

```bash
pnpm dev
```

### 4. 测试功能

访问 `http://localhost:3000`，在页面中输入内容并点击"生成故事开头"按钮测试功能。

## 安全优势

1. **API 密钥保护：** 密钥只在服务端使用，不会暴露到浏览器
2. **错误处理：** 统一的错误处理和用户友好的错误信息
3. **类型安全：** 完整的 TypeScript 类型定义
4. **可扩展性：** 易于添加更多 AI 功能和选项

## API 路由功能

服务端 API 路由 (`/api/generate`) 支持以下功能：

- **输入验证：** 检查请求参数的有效性
- **错误分类：** 根据不同的错误类型返回相应的错误信息
- **参数配置：** 支持模型选择、令牌数量、温度等参数
- **日志记录：** 记录错误信息便于调试

## 故障排除

### 常见问题

1. **"API密钥配置错误"**
   - 检查 `.env.local` 文件中的 API 密钥是否正确
   - 确保文件位于项目根目录

2. **"API配额已用完"**
   - 检查 OpenAI 账户余额
   - 验证 API 密钥是否有效

3. **"生成失败，请检查网络连接"**
   - 检查网络连接是否正常
   - 确认开发服务器正在运行

4. **构建时出现环境变量错误**
   - 确保环境变量名称正确（`OPENAI_API_KEY`）
   - 重启开发服务器

## 后续优化建议

1. **添加速率限制：** 防止 API 滥用
2. **缓存机制：** 缓存常见请求提高响应速度
3. **用户认证：** 添加用户登录和权限管理
4. **监控和日志：** 添加更详细的请求监控